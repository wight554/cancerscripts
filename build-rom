#!/bin/bash

# Common script
source "$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" || return; pwd)/common"

# Input
ROM="${1}"
DEVICE="${2}"
GDRIVE="${3}"
SHUTDOWN="${4}"

# Build dirs
ROM_PATH="${HOME}/${ROM}"

# Start tracking time
START="$(date +%s)"

# Check ROM
if [ "${ROM}" == "abc" ]
then
  info "Let's build karntest ROM..."
elif [ "${ROM}" == "aosip" ]
then
  info "Let's build weird birb ROM.."
else
  die "Choose AOSIP or ABC to proceed!"
fi

# Setup environment
info "Setting up build environment"
cd "${ROM_PATH}"
. build/envsetup.sh

# Set the device
if [ -z "${DEVICE}" ]
then
  die "Choose device to proceed!"
fi
info "Setting up the device..."
if [ "${ROM}" == "abc" ]
then
  breakfast "${DEVICE}-userdebug"
elif [ "${ROM}" == "aosip" ]
then
  lunch "aosip_${DEVICE}-userdebug"
fi

# ROM related stuffs
if [ "${ROM}" == "abc" ]
then
  ROMNAME=ABC-*${DEVICE}*$(date +'%Y%m%d').zip
elif [ "${ROM}" == "aosip" ]
then
  ROMNAME=AOSiP*${DEVICE}*.zip
fi

# Rom zip name
ROMZIP="${ROM_PATH}/out/target/product/${DEVICE}/${ROMNAME}"

# Always do installclean
make installclean

#  Start compilation
info "Compiling ${ROM} for ${DEVICE} and saving a build log file"
if [ "${ROM}" == "abc" ]
then
  mka bacon 2>&1 | tee "${HOME}/logs/buildrom.log"
elif [ "${ROM}" == "aosip" ]
then
  time mka kronic 2>&1 | tee "${HOME}/logs/build.log"
fi

# If the above was successful
if [[ -f "${ROMZIP}" ]]
then
  success "Build successful"
  # Google Drive upload
  if [ "${GDRIVE}" == "gdrive" ]
  then
    info "Uploading build to Google Drive"
    gdrive upload "${ROMZIP}"
    # Upload changelog if ABC
    if [ "${ROM}" == "abc" ]
    then
      gdrive upload ${ROM_PATH}/out/target/product/${DEVICE}/Changelog-*${DEVICE}*$(date +'%Y%m%d').txt
    fi
  fi
# If the build failed
else
  failed "Build failed"
fi

# Stop tracking time
END="$(date +%s)"
info "Build time: $(echo "$(("${END}"-"${START}"))" | awk '{print int($1/60)" minutes and "int($1%60)" seconds"}')"

# Shutdown the system if required by the user
if [ "${SHUTDOWN}" == "off" ]
then
  sudo poweroff
fi

# Kill java if it's hanging on
pkill java
